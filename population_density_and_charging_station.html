<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>人口密度与充电桩规划</title>
</head>

<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="main" style="height:1100px;width:1100px; z-index:1;position:absolute;background-color:white;")></div>
	<!--<div id="main" style="height:1100px;width:1100px; float:left")></div>-->
	<div id="statistics" style="z-index:2;position:absolute;background-color:white;top:30px;display:none">
			<p>当前选中的区域是:</p>
			<textarea id="SelectedArea" readonly="readonly" rows=3 cols=30/> </textarea>
			<p>该区域中的充电桩统计信息:</p>
			<textarea id="ChargingInfo" readonly="readonly" rows=5 cols=30/></textarea>
	</div>

	<!-- ECharts单文件引入 -->
    <script src="echarts-master/build/dist/echarts.js"></script>
	<!--<script src="http://libs.baidu.com/jquery/1.9.0/jquery.min.js" type="text/javascript"></script>-->
	<script type="text/javascript" src="libs/jquery-1.11.3.min.js"></script> 
	<!--<script type="text/javascript" src="libs/jquery.subscribe.js"></script>-->
	

	<script type="text/javascript">
		//加载json数据
		var population_density_data, charging_stations_data, charging_stations_geoCoord, heat_data;
		$.getJSON('population_density_and_charging_station/data.json',function(json){
			population_density_data = json.data;
			charging_stations_data = json.charging_stations_info;
			charging_stations_geoCoord = json.charging_stations_geoCoord;
			heat_data= json.heat_data;
			console.log("load json data finished");
			});
	</script>

	<script type="text/javascript">
    	//处理得到热力数据
		//console.log("make heat data begin");
		//var heat_data = heat_data_preprocess;
		/*
		var heat_data = [];
		for(var i = 0; i < heat_data_preprocess.length; i ++){
			//for(var j = 0; j < 100; j ++){	//重复100遍，否则数量太少，显示不出效果
				heat_data.push([heat_data_preprocess[i].x, heat_data_preprocess[i].y, heat_data_preprocess[i].value]);
			//}
		}
		*/

		//console.log("make heat data finished");

	</script>
	<script type="text/javascript">
		//console.log(population_density_data);
		//setTimeout(function show_map(){	
				// 路径配置
				require.config({
					paths: {
						echarts: 'echarts-master/build/dist'
					}
				});
				
				//alert(2);
		
						
				console.log("show map begin");
				require(
					[
						'echarts',
						'echarts/chart/map' // 使用地图，按需加载
						//'ecahrts/chart/markPoint'
					],
					function (ec) {
						// 基于准备好的dom，初始化echarts图表
						var myChart = ec.init(document.getElementById('main')); 

						option = {
							title : {
								text: '人口密度与充电站规划',
								x:'center',
								textStyle: {
									fontSize: '20',
								}
							},
							tooltip : {
								trigger: 'item',
								formatter: function (params,ticket,callback) {
									//console.log(params);
									
									if(params[5].type == null || params[5].type == undefined){	//说明是地区区块
										return params[5].name + "<br/>人口密度: " + params[5].value;
										
									}else{	//说明是markPoint
										return params[5].name + "<br/>类别: " + params[5].type + "<br/>功率: " + params[5].power + "<br/>电压: " + params[5].voltage;
									}
								}
							},
							/*
							legend: {
								orient: 'vertical',
								x:'left',
								data:['iphone3','iphone4','iphone5']
							},
							*/
							dataRange: {
								min: 0,
								max: 2500,
								x: 'left',
								y: 'bottom',
								text:['高','低'],           // 文本，默认为数值文本
								calculable : true
							},
							toolbox: {
								show: true,
								orient : 'vertical',
								x: 'right',
								y: 'center',
								feature : {
									mark : {show: true},
									dataView : {show: true, readOnly: false},
									restore : {show: true},
									saveAsImage : {show: true}
								}
							},
							roamController: {
								show: true,
								x: 'right',
								mapTypeControl: {
									'北京': true
								}
							},
							series : [
								{
									name: 'charging station plan',
									type: 'map',
									mapType: '北京',
									roam: false,
									selectedMode:  'multiple',
									itemStyle:{
										normal:{label:{show:true}},	//未mouseover的情况下是否显示label
										emphasis:{label:{show:true}} 	//mouseover的情况下是否显示label
									},
									data:population_density_data,
									markPoint:{
										symbolSize: 10,
										//large: true,
										itemStyle: {
											normal: {
												borderColor: '87cefa',
												borderWidth: 1,
												label: {
													show:false,
													
													formatter: function (params,ticket,callback) {//格式化展现（标签+值）
														return params.name + params.value;
														//return params.value + params.name;
													}  
												}
											},
											emphasis: {
												borderColor: '1e90ff',
												borderWidth: 5,
												label: {
													show: false,
													formatter: function (params,ticket,callback) {//格式化展现（标签+值）
														return params.name + params.value;
														//return params.value + params.name;
													}  
												}
											}
										},
										data: charging_stations_data,
										
									},
									geoCoord : charging_stations_geoCoord,
									heatmap: {
										blurSize: 30,
										gradientColors: ['blue', 'cyan', 'lime', 'yellow', 'red'],
										minAlpha: 0.1,
										valueScale: 1,
										opacity: 1,
									 	data: heat_data

									}
								}
							]	
							
						};
							
				  


						// 为echarts对象加载数据 
						myChart.setOption(option); 

						console.log("show map finished");
					
					
						var ecConfig = require('echarts/config');
						myChart.on(ecConfig.EVENT.MAP_SELECTED, function (param){
							//获取选中的区域
							var selected = param.selected;		//param.selected = ｛"a": true, "b": undefined｝
							var str = ""; 
							
							for (var p in selected) {
								if (selected[p]) {
									str += p + ' ';
								}
							}
							if(str != ""){
								document.getElementById("statistics").style.display = "block";	//若有选中，则显示该统计信息的div
								document.getElementById("SelectedArea").value = str;
								//console.log(str);
							
								//获取选中区域内的充电站信息
								var count_A = 0;
								var count_B = 0;
								for(var i = 0; i < charging_stations_data.length; i ++){
									if(selected[charging_stations_data[i].location]){
										if(charging_stations_data[i].type == "A类"){
											count_A ++;
										}else if (charging_stations_data[i].type == "B类"){
											count_B ++;
										}
									}
								}
								/** 格式化输入字符串**/
								//用法: "hello{0}".format('world')；返回'hello world'
								String.prototype.format= function(){
									var args = arguments;
									return this.replace(/\{(\d+)\}/g,function(s,i){
									return args[i];
									});
								}
								document.getElementById("ChargingInfo").value = "A类充电站共有{0}个\nB类充电站共有{1}个".format(count_A, count_B);
							}else{
								document.getElementById("statistics").style.display = "none";	//若无选中，则隐藏该统计信息的DIV

							}



						})
					});
		
    </script>
	
</body>
</html>
